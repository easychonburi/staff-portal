<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Time Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #FFF9F0; color: #333; min-height: 100vh; overflow-x: hidden; }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }
        
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ED1C24; z-index: 100; padding: 2rem; text-align: center; transition: opacity 0.5s; }
        .login-brand { margin-top: 15vh; margin-bottom: 2rem; }
        .brand-text-main { font-size: 3rem; font-weight: 800; color: #FFDE17; line-height: 1; }
        .login-instruction { color: white; font-size: 1.5rem; font-weight: 600; margin-bottom: 2rem; line-height: 1.4; }
        .pin-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 3rem; }
        .pin-input { width: 60px; height: 60px; background-color: #FFF9F0; border: none; border-radius: 12px; text-align: center; font-size: 2rem; font-weight: bold; color: #333; outline: none; }
        .pin-input:focus { box-shadow: 0 0 0 4px rgba(255, 222, 23, 0.5); }
        .btn-login { background-color: #FFDE17; color: #000; font-size: 1.5rem; font-weight: 800; padding: 12px 40px; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn-login:disabled { background-color: #ccc; cursor: not-allowed; }

        #dashboard-section { padding-bottom: 40px; }
        .dashboard-header { background-color: #ED1C24; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; padding: 20px 20px 30px 20px; color: white; display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header-left h1 { color: #FFDE17; font-size: 1.8rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .header-left h2 { font-size: 1.4rem; font-weight: 500; }
        .container { padding: 0 20px; max-width: 500px; margin: 0 auto; }
        .card { background: white; border: 2px solid #000; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        
        .location-grid { display: flex; align-items: center; gap: 15px; }
        .status-dot { width: 50px; height: 50px; background: #ccc; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
        .status-dot.active { background: linear-gradient(135deg, #2ecc71, #27ae60); box-shadow: 0 0 10px #2ecc71; }
        .status-dot.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .location-info h3 { font-size: 1.2rem; margin-bottom: 5px; }
        .location-info p { font-size: 0.9rem; color: #555; margin-bottom: 2px; }
        .text-status { font-weight: 600; font-size: 0.9rem; }
        .text-green { color: #27ae60; }
        .text-red { color: #c0392b; }

        .clock-card { text-align: center; }
        .clock-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
        .digital-clock { font-size: 3rem; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; letter-spacing: 2px; }

        .action-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .action-btn { flex: 1; border: none; border-radius: 20px; padding: 25px 10px; color: white; cursor: pointer; text-align: center; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.15); opacity: 0.5; pointer-events: none; }
        .action-btn.ready { opacity: 1; pointer-events: auto; }
        .action-btn:active { transform: scale(0.96); }
        .btn-checkin { background-color: #009245; }
        .btn-checkout { background-color: #ED1C24; }
        .action-btn small { display: block; font-size: 1rem; opacity: 0.9; }
        .action-btn span { display: block; font-size: 1.8rem; font-weight: 800; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ED1C24; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .history-section { background: #fff; border-radius: 20px; padding: 20px; border: 2px solid #000; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .history-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .history-list { list-style: none; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 1rem; color: #555; }
        .history-item:last-child { border-bottom: none; }

        /* Modal CSS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        .modal-btn { background: #ED1C24; color: white; border: none; padding: 12px 25px; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 5px; }
        .modal-btn.action-req { background: #ffc107; color: #000; margin-bottom: 10px; }
        
        .status-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ffeeba; font-size: 0.9rem; text-align: left; }
        .status-alert.late { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-alert.ot { background: #d4edda; color: #155724; border-color: #c3e6cb; }

        .checkmark-circle { width: 80px; height: 80px; position: relative; display: inline-block; vertical-align: top; margin-bottom: 10px; }
        .checkmark-circle .background { width: 80px; height: 80px; border-radius: 50%; background: #4CAF50; position: absolute; }
        .checkmark-circle .draw:after { content: ''; position: absolute; left: 22px; top: 40px; width: 35px; height: 15px; border-bottom: 5px solid white; border-left: 5px solid white; transform: scaleX(-1) rotate(135deg); transform-origin: left top; animation: checkmark 0.6s ease forwards; }
        @keyframes checkmark { 0% { height: 0; width: 0; opacity: 0; } 50% { opacity: 1; height: 0; width: 0; } 100% { height: 15px; width: 35px; opacity: 1; } }
        .modal-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #ED1C24; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
    </style>
</head>
<body>

    <section id="login-section" class="flex-center flex-col">
        <div class="login-brand"><div class="brand-text-main">EASY</div></div>
        <div class="login-instruction">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>4 ‡∏´‡∏•‡∏±‡∏Å (PIN)</div>
        <div class="pin-container">
            <input type="tel" maxlength="1" class="pin-input" id="pin-1" data-index="1">
            <input type="tel" maxlength="1" class="pin-input" id="pin-2" data-index="2">
            <input type="tel" maxlength="1" class="pin-input" id="pin-3" data-index="3">
            <input type="tel" maxlength="1" class="pin-input" id="pin-4" data-index="4">
        </div>
        <button class="btn-login" id="btnLoginBtn" onclick="handleLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <p id="loginStatus" style="color:white; margin-top:15px; font-weight:300; min-height:24px;"></p>
    </section>

    <section id="dashboard-section" class="hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <h1>EASY</h1>
                <h2 id="userNameDisplay">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h2>
                <small id="userBranchDisplay" style="color:#FFDE17;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</small>
            </div>
            <div class="menu-icon" onclick="location.reload()">‚Üª</div>
        </div>

        <div class="container">
            <div class="card location-card">
                <div class="location-grid">
                    <div id="statusDot" class="status-dot"></div>
                    <div class="location-info">
                        <h3>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <p id="locationName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>
                        <p id="distanceText">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                        <p id="statusText" class="text-status" style="color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS...</p>
                    </div>
                </div>
            </div>

            <div class="card clock-card">
                <div class="clock-title">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
                <div class="digital-clock" id="live-clock">00:00:00</div>
            </div>

            <div class="action-row">
                <button id="btnIn" class="action-btn btn-checkin" onclick="recordAction('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')">
                    <small>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</small>
                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span>
                </button>
                <button id="btnOut" class="action-btn btn-checkout" onclick="recordAction('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')">
                    <small>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</small>
                    <span>‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</span>
                </button>
            </div>

            <div class="history-section">
                <div class="history-title">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (4 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</div>
                <ul class="history-list" id="history-list">
                    <li class="history-item" style="justify-content: center; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
                </ul>
            </div>
        </div>
    </section>

    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-box">
            <div id="modalLoading">
                <div class="modal-spinner"></div>
                <div class="modal-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
                <div class="modal-desc">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
            <div id="modalSuccess" class="hidden">
                <div class="checkmark-circle">
                    <div class="background"></div>
                    <div class="draw"></div>
                </div>
                <div class="modal-title" style="color:#4CAF50;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
                <div class="modal-desc" id="modalSuccessMsg">‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                
                <div id="modalAlertArea"></div>

                <button class="modal-btn" onclick="closeModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

   <script>
        // üî¥üî¥ ‡πÉ‡∏™‡πà URL ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏¥‡∏ß‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbzbVQiuK7-NLYL-W76qMuKl4p1OvigkFPw7oOiYMgxmnK3WUPxQqUJluq-PusnbAiAk/exec";

        // ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏∞‡∏á‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç 25 ‡πÅ‡∏ó‡∏ô‡∏ï‡∏µ 1)
        const SHIFT_1_START = 9;  const SHIFT_1_END = 17;
        const SHIFT_2_START = 17; const SHIFT_2_END = 25;

        var currentUser = {};
        var currentLocation = { lat: 0, lng: 0, name: "Unknown" };
        var isLocationReady = false;
        var pendingStatus = "‡∏õ‡∏Å‡∏ï‡∏¥";

        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô
        var shopLocations = [
            {"name":"‡∏≠‡∏°‡∏ï‡∏∞‡∏ô‡∏Ñ‡∏£", "lat":13.4429015, "lng":101.0299502},
            {"name":"‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏™‡∏±‡∏à‡∏à‡∏≤", "lat":13.3478668, "lng":100.971527},
            {"name":"‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô", "lat":13.2806205, "lng":100.9330387},
            {"name":"‡∏≠‡πà‡∏≤‡∏ß‡∏≠‡∏∏‡∏î‡∏°", "lat":13.1144392, "lng":100.9249934},
            {"name":"‡∏´‡∏ô‡∏≠‡∏á‡∏ï‡∏≥‡∏•‡∏∂‡∏á", "lat":13.41045, "lng":101.055621},
            {"name":"‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô", "lat":13.824285, "lng":100.590109}
        ];

        window.onload = function() {
            updateClock(); setInterval(updateClock, 1000); watchLocation();
            document.getElementById('pin-1').focus();
        };

        const pinInputs = document.querySelectorAll('.pin-input');
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1) {
                    const nextInput = document.querySelector(`#pin-${index + 2}`);
                    if (nextInput) nextInput.focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '') {
                    const prevInput = document.querySelector(`#pin-${index}`);
                    if (prevInput) prevInput.focus();
                }
            });
        });

        function handleLogin() {
            let pin = '';
            pinInputs.forEach(input => pin += input.value);
            if (pin.length !== 4) { document.getElementById('loginStatus').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 4 ‡∏´‡∏•‡∏±‡∏Å"; return; }
            const btn = document.getElementById('btnLoginBtn');
            const status = document.getElementById('loginStatus');
            btn.disabled = true; btn.innerHTML = '<div class="loader"></div>'; status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

            fetch(API_URL + "?action=verifyPin&pin=" + pin)
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    currentUser = result; 
                    if(!currentUser.role) currentUser.role = 'daily'; 
                    enterDashboard();
                    fetchHistory();
                } else {
                    btn.disabled = false; btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; status.innerText = "‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
                    pinInputs.forEach(input => input.value = ''); document.getElementById('pin-1').focus();
                }
            }).catch(err => { btn.disabled = false; btn.innerText = "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"; status.innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; });
        }

        function enterDashboard() {
            document.getElementById('userNameDisplay').innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì" + currentUser.name;
            document.getElementById('userBranchDisplay').innerText = "‡∏™‡∏≤‡∏Ç‡∏≤: " + currentUser.branch;
            const loginSec = document.getElementById('login-section');
            loginSec.style.opacity = '0';
            setTimeout(() => {
                loginSec.classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden');
                if(currentLocation.lat !== 0) updatePosition({coords: {latitude: currentLocation.lat, longitude: currentLocation.lng}});
            }, 500);
        }

        function fetchHistory() {
            const list = document.getElementById('history-list');
            fetch(API_URL + "?action=getHistory&name=" + currentUser.name)
            .then(res => res.json())
            .then(history => {
                list.innerHTML = ""; 
                if(history.length === 0) { list.innerHTML = '<li class="history-item" style="justify-content: center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>'; return; }
                const limitHistory = history.slice(0, 4);
                limitHistory.forEach(item => {
                    let timeShow = item.time.substring(0, 5); 
                    let color = item.action.includes("‡πÄ‡∏Ç‡πâ‡∏≤") ? "#009245" : "#ED1C24";
                    let li = document.createElement('li'); li.className = 'history-item';
                    li.innerHTML = `<span>${item.date} ${timeShow}</span> <span style="font-weight:bold; color:${color}">${item.action}</span>`;
                    list.appendChild(li);
                });
            }).catch(err => { list.innerHTML = '<li class="history-item" style="color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</li>'; });
        }

        function recordAction(actionType, note = "") {
            if (!isLocationReady) { alert("‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠ GPS ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"); return; }
            if (note === "") {
                const modal = document.getElementById('customModal');
                const loading = document.getElementById('modalLoading');
                const success = document.getElementById('modalSuccess');
                modal.classList.remove('hidden'); loading.classList.remove('hidden'); success.classList.add('hidden');
            }

            let statusToSend = pendingStatus; 
            if (note === "") statusToSend = "‡∏õ‡∏Å‡∏ï‡∏¥"; 

            var data = { 
                name: currentUser.name, 
                action: actionType, 
                location: currentLocation.name, 
                lat: currentLocation.lat, 
                lng: currentLocation.lng,
                status: statusToSend,
                note: note
            };

            fetch(API_URL, { method: "POST", body: JSON.stringify(data) })
            .then(res => res.json())
            .then(result => {
                if (note === "") {
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Success
                    document.getElementById('modalLoading').classList.add('hidden');
                    document.getElementById('modalSuccess').classList.remove('hidden');
                    document.getElementById('modalAlertArea').innerHTML = ""; 
                    if (currentUser.role === 'daily') checkTimeLogic(actionType);
                    
                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
                    fetchHistory();
                } else {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    closeModal(); // ‡∏õ‡∏¥‡∏î Modal ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏á Note ‡πÄ‡∏™‡∏£‡πá‡∏à
                }
            })
            .catch(err => { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); closeModal(); });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal (‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤)
        function closeModal() {
            const modal = document.getElementById('customModal');
            modal.classList.add('hidden');
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì 2 ‡∏Å‡∏∞ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ô)
        function checkTimeLogic(action) {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();

            // ‚ö†Ô∏è ‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏µ 1) ‡πÉ‡∏´‡πâ‡∏ö‡∏ß‡∏Å 24 ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà 25 (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å 17:00 ‡πÑ‡∏î‡πâ)
            if (hours < 5) {
                hours += 24;
            }

            const totalMinutes = (hours * 60) + minutes;
            const container = document.getElementById('modalAlertArea');

            // --- ‡πÄ‡∏î‡∏≤‡∏Å‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤(‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß) ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 15:00 (‡∏ö‡πà‡∏≤‡∏¢ 3) -> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô -> ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢
            let targetStart, targetEnd;
            if (hours < 15) {
                targetStart = SHIFT_1_START; targetEnd = SHIFT_1_END; // ‡∏Å‡∏∞ 1
            } else {
                targetStart = SHIFT_2_START; targetEnd = SHIFT_2_END; // ‡∏Å‡∏∞ 2
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≤‡∏¢ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô)
            if (action.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô")) {
                const workStart = (targetStart * 60); 
                const lateLimit = workStart + 10; // ‡∏™‡∏≤‡∏¢‡πÑ‡∏î‡πâ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
                
                if (totalMinutes > lateLimit) {
                    const lateMin = totalMinutes - workStart;
                    pendingStatus = `‡∏™‡∏≤‡∏¢ ${lateMin} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    container.innerHTML = `
                        <div class="status-alert late">
                            <b>üî¥ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏¢ ${lateMin} ‡∏ô‡∏≤‡∏ó‡∏µ</b><br>
                            ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏è‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                        </div>
                        <button class="modal-btn action-req" onclick="submitReason('${action}', '‡∏™‡∏≤‡∏¢ ${lateMin} ‡∏ô‡∏≤‡∏ó‡∏µ')">üìù ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</button>
                    `;
                }
            }

            // ‡πÄ‡∏ä‡πá‡∏Ñ OT (‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô)
            if (action.includes("‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô")) {
                const workEnd = (targetEnd * 60);
                const otStart = workEnd + 15; // OT ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏¥‡∏Å 15 ‡∏ô‡∏≤‡∏ó‡∏µ
                
                if (totalMinutes > otStart) {
                    const otMin = totalMinutes - workEnd;
                    pendingStatus = `OT ${otMin} ‡∏ô‡∏≤‡∏ó‡∏µ`;
                    container.innerHTML = `
                        <div class="status-alert ot">
                            <b>üü¢ ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${otMin} ‡∏ô‡∏≤‡∏ó‡∏µ</b><br>
                            ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (OT)
                        </div>
                        <button class="modal-btn action-req" onclick="submitReason('${action}', '‡∏Ç‡∏≠ OT ${otMin} ‡∏ô‡∏≤‡∏ó‡∏µ')">üí∞ ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠ OT</button>
                    `;
                }
            }
        }
       
        function submitReason(action, statusMsg) {
            let reason = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:");
            if (reason) {
                pendingStatus = statusMsg;
                recordAction(action, reason); 
            }
        }

        function watchLocation() {
            if (navigator.geolocation) { navigator.geolocation.watchPosition(updatePosition, showGpsError, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }); } 
            else { showGpsError({ message: "Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS" }); }
        }
        function updatePosition(position) {
            var lat = position.coords.latitude; var lng = position.coords.longitude;
            currentLocation.lat = lat; currentLocation.lng = lng;
            var nearest = null; var minDist = 9999999; 
            for(var i=0; i<shopLocations.length; i++) {
                var c = getDistanceFromLatLonInKm(lat, lng, shopLocations[i].lat, shopLocations[i].lng);
                if(c < minDist) { minDist = c; nearest = shopLocations[i]; }
            }
            const dot = document.getElementById('statusDot'); const locName = document.getElementById('locationName');
            const distText = document.getElementById('distanceText'); const statusText = document.getElementById('statusText');
            const btnIn = document.getElementById('btnIn'); const btnOut = document.getElementById('btnOut'); const ALLOWED_RADIUS = 0.5;

            if (nearest) {
                var distMeters = Math.round(minDist * 1000);
                locName.innerText = "‡πÉ‡∏Å‡∏•‡πâ: " + nearest.name; distText.innerText = "‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: " + distMeters + " ‡πÄ‡∏°‡∏ï‡∏£"; currentLocation.name = nearest.name;
                if (minDist <= ALLOWED_RADIUS) {
                    dot.className = "status-dot active"; statusText.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ"; statusText.className = "text-status text-green";
                    btnIn.classList.add('ready'); btnOut.classList.add('ready'); isLocationReady = true;
                } else {
                    dot.className = "status-dot error"; statusText.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚ùå ‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; statusText.className = "text-status text-red";
                    btnIn.classList.remove('ready'); btnOut.classList.remove('ready'); isLocationReady = false;
                }
            }
        }
        function showGpsError(error) { document.getElementById('statusText').innerText = "‚ö†Ô∏è ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"; document.getElementById('statusText').className = "text-status text-red"; }
        function updateClock() { const now = new Date(); document.getElementById('live-clock').textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) { var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function deg2rad(deg) { return deg * (Math.PI/180); }
   </script>
</body>
</html>
